image: chips4makers/build37_gf180mcupdk

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYPI_INDEX: "https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/api/v4/groups/${CI_PROJECT_NAMESPACE}/-/packages/pypi/simple"
cache:
  paths:
    - .cache/pip

before_script:
  - python --version  # For debugging
  - pip config set global.index-url "${PYPI_INDEX}"
  - pip install --pre PDKMaster c4m-flexcell~=0.4.0.dev0

dist:
  only:
    - main
    - dev_v0.1
  variables:
    TWINE_PASSWORD: '${CI_JOB_TOKEN}'
    TWINE_USERNAME: 'gitlab-ci-token'
    TWINE_REPOSITORY_URL: 'https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/pypi'
  script:
    # Need to fetch tags
    - git fetch --tags
    - doit dist
    - python -m twine check --strict dist/*
    - python -m twine upload --verbose dist/*

dist-test:
  except:
    - main
    - dev_v0.1
  script:
    # Need to fetch tags
    - git fetch --tags
    - doit dist
    - python -m twine check --strict dist/*

install:
  script:
    - doit install

# test:
#   script:
#     - doit unittest
#     - cat test/cover_report.log # Get coverage

release:
  variables:
    USER: root
  script:
    - doit -n $(nproc) tarball
  artifacts:
    paths:
      - open_pdk
