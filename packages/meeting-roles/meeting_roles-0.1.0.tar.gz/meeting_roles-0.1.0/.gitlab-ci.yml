image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/python:3.9

stages:
  - build
  - deploy

variables:
  PYPI_REPO_URL: "https://upload.pypi.org/legacy/"
  PYPI_USERNAME: __token__
  PYPI_PASSWORD: $PYPI_TOKEN
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip

before_script:
  - python -V
  - pip install wheel twine setuptools

build:
  stage: build
  script:
    - python setup.py bdist_wheel --universal sdist;
  artifacts:
    paths:
      - dist/*
  when: manual

deploy:
  stage: deploy
  script:
    - cd setup
    - for dir in `ls -d */`; do
        if [[ ! ",${EXCLUDED_MODULES}," =~ ",${dir%%/}," ]]; then
          cd $dir;
          twine upload --repository-url $PYPI_REPO_URL -u $PYPI_USERNAME -p /
          $PYPI_PASSWORD dist/*;
          cd ..;
        fi
      done
  when: manual
