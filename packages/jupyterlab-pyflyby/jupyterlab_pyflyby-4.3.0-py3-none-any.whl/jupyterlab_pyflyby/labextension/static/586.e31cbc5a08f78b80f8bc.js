"use strict";(self.webpackChunk_deshaw_jupyterlab_pyflyby=self.webpackChunk_deshaw_jupyterlab_pyflyby||[]).push([[586],{586:(t,e,o)=>{o.r(e),o.d(e,{default:()=>F});var s=o(918),n=o(431),i=o(884),r=o(194),l=o(679),a=o(215),c=o(923),d=o(840),h=o(305),m=o(271),u=o.n(m);const y="pyflyby-cell",g="# END AUTO-GENERATED BLOCK\n",p="pyflyby.missing_imports",_="pyflyby.format_imports",b="pyflyby.init_comms",f="pyflyby.tidy_imports",C=t=>"string"==typeof t?t.split("\n"):t,w=t=>!(t.startsWith("#")||t.startsWith('"""')||""===t.trim()||t.match(/^\s.*$/))||t.startsWith("%"),x=t=>""===t.trim()||!t.match(/^\s.*$/);var k=o(848),L=o(613);async function S(t="",e={}){const o=L.ServerConnection.makeSettings(),s=k.URLExt.join(o.baseUrl,"pyflyby",t);let n;try{n=await L.ServerConnection.makeRequest(s,e,o)}catch(t){throw new L.ServerConnection.NetworkError(t)}let i=await n.text();if(i.length>0)try{i=JSON.parse(i)}catch(t){console.log("Not a JSON response body.",n)}if(!n.ok)throw new L.ServerConnection.ResponseError(n,i.message||i);return i}const T=(0,h.debug)("PYFLYBY:");class v{constructor(t,e){this._lockTimeout=t,this._activeTimeout=null,this.requestedLockCount=0,this.clearedLockCount=0,this._releaseLock={},this.promise={0:Promise.resolve()},this._timeoutSignal=new d.Signal(this),this._sessionContext=e,this._sessionContext.statusChanged.connect(this.kernelStateRecorder,this),this._timeoutSignal.connect(this.timeoutExpireHandler,this)}kernelStateRecorder(t,e){this._recentKernelState=e}_clearTimeout(){window.clearTimeout(this._activeTimeout),this._activeTimeout=null}timeoutExpireHandler(t,e){this._clearTimeout(),"busy"===this._recentKernelState?(console.debug("Extending Timeout For: ",e),this.createTimeout(e)):this.release(e)}async acquire(){const t=this.promise[this.requestedLockCount];this.requestedLockCount++;const e=this.requestedLockCount;return this.promise[e]=new Promise((t=>{this._releaseLock[e]=t})),await t,new Promise(((t,o)=>t(e)))}release(t){var e,o;this.clearedLockCount=t,null===(o=(e=this._releaseLock)[t])||void 0===o||o.call(e),delete this._releaseLock[t],this._clearTimeout(),this.clearedLockCount<this.requestedLockCount&&this.createTimeout(t+1)}createTimeout(t){this._activeTimeout=setTimeout((()=>{this._timeoutSignal.emit(t)}),this._lockTimeout)}}let Y=!1;class I extends n.Widget{constructor(t,e,o){super(),this._context=null,this._sessionContext=null,this._settings=null,this._comms={},o.load("@deshaw/jupyterlab-pyflyby:plugin").then((t=>{this._settings=t,(t.get("enabled").user||t.get("enabled").composite)&&(this._sessionContext.kernelChanged.connect(this._handleKernelChange,this),this._sessionContext.statusChanged.connect(this._handleKernelStatusChange,this));const e=1e3*(t.get("lockTimeout").user||t.get("lockTimeout").composite);this._lock=new v(e,this._sessionContext)}),(t=>{T("PYFLYBY extension has been disabled")})),this._context=t,this._sessionContext=t.sessionContext}async _launchDialog(t){const e=new i.Dialog({title:"PYFLYBY",body:"PYFLYBY will be adding imports to the first code cell in the notebook.\n            To disable the PYFLYBY extension or to disable this notification in future, go\n            to Settings -> Advanced Settings Editor and choose PYFLYBY preferences tab",buttons:[i.Dialog.okButton()]});try{return await e.launch(),t}catch(t){console.error(t)}}_findAndSetImportCoordinates(){const{model:t}=this._context;let e=s.ArrayExt.findFirstIndex((0,s.toArray)(t.cells),((t,e)=>{const o=t.metadata.get("tags");return!(!o||-1===o.indexOf(y))}));-1===e&&(e=(t=>{const e=(0,s.toArray)(t);for(let t=0;t<e.length;t++){const o=e[t];if("code"===o.type){const e=C(o.toJSON().source);if(e.length>0&&!e[0].startsWith("%")&&!e[0].startsWith('"""'))for(let o=0;o<e.length;o++)if(w(e[o]))return t}}return-1})((0,s.toArray)(t.cells)));let o=t.cells.get(e),n=(t=>{const e=C(t.toJSON().source);for(let t=e.length-1;t>=0;t--)if(e[t]===g.substr(0,26)){let o=0;for(let s=0;s<t-1;s++)o+=e[s].length+1;return o}for(let t=e.length-1;t>=0;t--)if(o=e[t],w(o)&&(o.includes("__future__")||-1!==o.split(" ").indexOf("import")||o.includes("import_all_names"))&&(t===e.length-1||x(e[t+1]))){let o=0;for(let s=0;s<=t;s++)o+=e[s].length+1;return o}var o;return-1})(t.cells.get(e));return-1===n&&(o=this._context.model.contentFactory.createCodeCell({cell:{source:`# THIS CELL WAS AUTO-GENERATED BY PYFLYBY\n\n\n${g}`,cell_type:"code",metadata:{}}}),this._context.model.cells.insert(e,o),n=43),o.metadata.set("tags",[y]),{cellIndex:e,position:n}}_insertImport(t){let e=null;return Y||this._settings.get("disableNotification").user?e=Promise.resolve(t):(e=this._launchDialog(t),Y=!0),this._findAndSetImportCoordinates(),e}_sendFormatCodeMsg(t,e){const o=s.ArrayExt.findFirstIndex((0,s.toArray)(this._context.model.cells),((t,e)=>{const o=t.metadata.get("tags");return!(!o||-1===o.indexOf(y))}));if(-1!==o){const s=this._context.model.cells.get(o).toJSON().source,n=this._comms[_];n&&!n.isDisposed&&n.send({msg_id:e,input_code:s,imports:t,type:_})}}async sendTidyImportRequest(){const t=this._getCellArray(),e=this._comms[f];e&&!e.isDisposed&&e.send({type:f,cellArray:t,checksum:this._getHashOfCodeInNotebook()})}_getCellArray(){const t=this._context.model.cells,e=[];for(let o=0;o<t.length;++o)e.push({text:t.get(o).value.text,type:t.get(o).type});return e}restoreNotebookAfterTidyImports(t,e){const{cellIndex:o}=this._findAndSetImportCoordinates(),s=this._context.model.cells;for(let e=0;e<t.length;++e){const o=s.get(e);o.value.remove(0,o.value.text.length),o.value.insert(0,t[e].text.trim())}const n=e.join("\n").trim();if(0===s.get(0).value.text.length)s.get(0).value.insert(0,n);else{const t=this._context.model.contentFactory.createCodeCell({cell:{source:n,cell_type:"code",metadata:{trusted:!0}}});s.insert(o,t)}}_fastStringHash(t){let e=0;for(let o=0,s=t.length;o<s;o++)e=(e<<5)-e+t.charCodeAt(o),e|=0;return e}_getHashOfCodeInNotebook(){const t=this._getCellArray();let e="";for(let o=0;o<t.length;++o)e+=t[o].text;return this._fastStringHash(e)}_getCommMsgHandler(){return async t=>{const e=t.content.data;switch(e.type){case p:{const t=e.missing_imports;this._insertImport(t).then((async t=>{const e=await this._lock.acquire();this._sendFormatCodeMsg(t,e)}));break}case _:{this._formatImports(e);const{msg_id:t}=e;this._lock.release(t);break}case b:this._initializeComms().catch(console.error);break;case f:{const{cells:t,imports:o,checksum:s}=e;s===this._getHashOfCodeInNotebook()?this.restoreNotebookAfterTidyImports(t,o):await(0,i.showDialog)({title:"TidyImports Interrupted",body:"TidyImports could not be run because code in the notebook has been changed",buttons:[i.Dialog.okButton({label:"Ok"})],defaultButton:0});break}}}}async _initializeComms(){if(!this._sessionContext.session)return;const{kernel:t}=this._sessionContext.session;if(!t)return;const e=p,o=t.createComm(e);o.onMsg=this._getCommMsgHandler();try{o.open()}catch(t){console.error(`Unable to open PYFLYBY comm - ${t}`)}const s=t.createComm(_);s.onMsg=this._getCommMsgHandler(),s.onClose=t=>{const e=t.content.comm_id;delete this._comms[e]},this._comms[_]=s;try{s.open()}catch(t){console.error(`Unable to open PYFLYBY comm - ${t}`)}const n=t.createComm(f);n.onMsg=this._getCommMsgHandler(),this._comms[f]=n;try{n.open()}catch(t){console.error(`Unable to open PYFLYBY comm - ${t}`)}return t.registerCommTarget(b,((t,e)=>{t.onMsg=this._getCommMsgHandler()})),Promise.resolve()}_formatImports(t){const{formatted_code:e}=t,o=s.ArrayExt.findFirstIndex((0,s.toArray)(this._context.model.cells),((t,e)=>{const o=t.metadata.get("tags");return!(!o||-1===o.indexOf(y))}));if(-1!==o){const t=this._context.model.cells.get(o);t.value.remove(0,t.value.text.length),t.value.insert(0,e)}}async _handleKernelChange(t,e){return await this._initializeComms()}_handleKernelStatusChange(t,e){return"restarting"===e?this._initializeComms():null}}class E{constructor(t){this._settingRegistry=null,this._settingRegistry=t,this._loadSettings().catch(console.error)}async _loadSettings(){try{await this._settingRegistry.load("@deshaw/jupyterlab-pyflyby:plugin"),T("Successfully loaded PYFLYBY extension settings")}catch(t){console.error("Settings could not be loaded")}}createNew(t,e){return P=new I(e,t,this._settingRegistry),P}}async function A(){try{await S("install-pyflyby",{method:"POST"})}catch(t){const e=await t.json();console.error(e.result)}}const N=u().createElement("div",null,u().createElement("p",null,"To use @deshaw/jupyterlab-pyflyby,"," ",u().createElement("a",{href:"https://github.com/deshaw/pyflyby/blob/master/README.rst",style:{color:"#0000EE"},target:"_blank",rel:"noopener noreferrer"},"pyflyby")," ","ipython extension needs to be installed."),u().createElement("br",null),u().createElement("p",null,'Clicking on "Install" will run following command'),u().createElement("div",{style:{font:"monospace",color:"#ffffff",backgroundColor:"#000000",marginTop:"5px"}},"$ py pyflyby.install_in_ipython_config_file"),u().createElement("br",null));class D{createNew(t,e){const o=new i.ToolbarButton({className:"tidy-import-button",tooltip:"Run tidy-imports on this notebook",icon:B,onClick:()=>P.sendTidyImportRequest()});return t.toolbar.insertItem(10,"tidy-imports",o),new c.DisposableDelegate((()=>{o.dispose()}))}}const B=new a.LabIcon({name:"DJSDocSearch",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!-- Font Awesome Pro 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) --\x3e<path d="M224 96l16-32 32-16-32-16-16-32-16 32-32 16 32 16 16 32zM80 160l26.66-53.33L160 80l-53.34-26.67L80 0 53.34 53.33 0 80l53.34 26.67L80 160zm352 128l-26.66 53.33L352 368l53.34 26.67L432 448l26.66-53.33L512 368l-53.34-26.67L432 288zm70.62-193.77L417.77 9.38C411.53 3.12 403.34 0 395.15 0c-8.19 0-16.38 3.12-22.63 9.38L9.38 372.52c-12.5 12.5-12.5 32.76 0 45.25l84.85 84.85c6.25 6.25 14.44 9.37 22.62 9.37 8.19 0 16.38-3.12 22.63-9.37l363.14-363.15c12.5-12.48 12.5-32.75 0-45.24zM359.45 203.46l-50.91-50.91 86.6-86.6 50.91 50.91-86.6 86.6z"/></svg>'});let P=null;const R="djs:run-tidy-imports",F={id:"@deshaw/jupyterlab-pyflyby:plugin",autoStart:!0,requires:[r.ISettingRegistry,l.INotebookTracker,i.ICommandPalette],activate:async function(t,e,o,s){console.log("JupyterLab extension @deshaw/jupyterlab-pyflyby is activated!"),t.commands.addCommand(R,{execute:()=>P.sendTidyImportRequest(),icon:B,label:"Run tidy-imports on Notebook"}),s.addItem({command:R,category:"Notebook"});const n=await e.load("@deshaw/jupyterlab-pyflyby:plugin"),r=n.get("enabled").user||n.get("enabled").composite,l=n.get("installDialogDisplayed").user;r&&"loaded"!==await async function(){return(await S("pyflyby-status")).status}()&&(l||(await(0,i.showDialog)({title:"Installation required",body:N,buttons:[i.Dialog.okButton({label:"Install"}),i.Dialog.cancelButton({label:"Cancel",displayType:"default"})],defaultButton:0})).button.accept?await A():await async function(t){try{await S("disable-pyflyby",{method:"POST",mode:"cors",cache:"no-cache",credentials:"include",headers:{"Content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams("installDialogDisplayed=true")})}catch(t){const e=await t.json();console.error(e.result)}await t.reload("@deshaw/jupyterlab-pyflyby:plugin")}(e)),t.docRegistry.addWidgetExtension("Notebook",new E(e)),t.docRegistry.addWidgetExtension("Notebook",new D)}}}}]);